#!/usr/bin/env python3
"""
Fast Data Comparison Tool
Compares standardized data between you and your coworker using hash-based indexing.
Optimized for large datasets (250k+ rows).
"""

import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext, ttk
import threading
import os
from collections import defaultdict

try:
    from openpyxl import Workbook, load_workbook
    from openpyxl.styles import Font, PatternFill, Alignment
except ImportError:
    print("Installing openpyxl...")
    import subprocess
    subprocess.check_call(['pip', 'install', 'openpyxl', '--break-system-packages'])
    from openpyxl import Workbook, load_workbook
    from openpyxl.styles import Font, PatternFill, Alignment


class FastDataComparisonGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Fast Data Comparison Tool")
        self.root.geometry("900x600")
        
        self.standardized_file = None
        
        self.setup_ui()
    
    def setup_ui(self):
        # Main frame
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # Title
        title_label = ttk.Label(main_frame, text="Fast Data Comparison Tool", 
                                font=('Arial', 16, 'bold'))
        title_label.grid(row=0, column=0, columnspan=3, pady=10)
        
        subtitle_label = ttk.Label(main_frame, 
                                   text="⚡ Optimized for large datasets (250k+ rows)", 
                                   font=('Arial', 10, 'italic'), foreground='blue')
        subtitle_label.grid(row=1, column=0, columnspan=3, pady=(0, 10))
        
        # File selection
        ttk.Label(main_frame, text="Standardized data file:").grid(row=2, column=0, sticky=tk.W, pady=5)
        self.file_label = ttk.Label(main_frame, text="No file selected", 
                                    foreground="gray", wraplength=500)
        self.file_label.grid(row=2, column=1, sticky=tk.W, padx=5)
        ttk.Button(main_frame, text="Browse...", command=self.select_file).grid(row=2, column=2, padx=5)
        
        # Info box
        info_frame = ttk.LabelFrame(main_frame, text="What this does", padding="10")
        info_frame.grid(row=3, column=0, columnspan=3, pady=20, sticky=(tk.W, tk.E))
        
        info_text = tk.Text(info_frame, height=10, width=100, wrap=tk.WORD)
        info_text.grid(row=0, column=0)
        info_text.insert(tk.END, "This tool compares YOUR DATA with COWORKER DATA using fast hash-based matching.\n\n")
        info_text.insert(tk.END, "It will find:\n")
        info_text.insert(tk.END, "  1. Entries in BOTH datasets (substring matching)\n")
        info_text.insert(tk.END, "  2. Entries ONLY in YOUR data (missing from coworker's)\n")
        info_text.insert(tk.END, "  3. Entries ONLY in COWORKER's data (missing from yours)\n\n")
        info_text.insert(tk.END, "Uses hash indexing for speed - processes 250k+ rows in seconds!\n\n")
        info_text.insert(tk.END, "Output: Detailed comparison report in Excel format")
        info_text.config(state=tk.DISABLED)
        
        # Compare button
        self.compare_button = ttk.Button(main_frame, text="Compare Data", 
                                        command=self.start_comparison, state=tk.DISABLED)
        self.compare_button.grid(row=4, column=0, columnspan=3, pady=20)
        
        # Progress bar
        self.progress = ttk.Progressbar(main_frame, mode='indeterminate', length=600)
        self.progress.grid(row=5, column=0, columnspan=3, pady=5)
        
        # Status text area
        ttk.Label(main_frame, text="Processing Status:").grid(row=6, column=0, columnspan=3, sticky=tk.W, pady=(10,0))
        self.status_text = scrolledtext.ScrolledText(main_frame, height=15, width=100, wrap=tk.WORD)
        self.status_text.grid(row=7, column=0, columnspan=3, pady=5)
        
        # Configure grid weights
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(1, weight=1)
        main_frame.rowconfigure(7, weight=1)
    
    def select_file(self):
        filepath = filedialog.askopenfilename(
            title="Select Standardized_Data.xlsx file",
            filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
        )
        if filepath:
            self.standardized_file = filepath
            self.file_label.config(text=os.path.basename(filepath), foreground="black")
            self.compare_button.config(state=tk.NORMAL)
    
    def log(self, message):
        self.status_text.insert(tk.END, message + "\n")
        self.status_text.see(tk.END)
        self.status_text.update()
    
    def start_comparison(self):
        self.compare_button.config(state=tk.DISABLED)
        self.status_text.delete(1.0, tk.END)
        self.progress.start()
        
        # Run comparison in separate thread
        thread = threading.Thread(target=self.compare_data)
        thread.start()
    
    def normalize_string(self, s):
        """Normalize string: uppercase and remove all whitespace"""
        return ''.join(s.upper().split())
    
    def build_hash_index(self, entries, sheet_name):
        """
        Build hash index for fast substring lookups.
        
        Args:
            entries: List of (entry_string, metadata) tuples
            sheet_name: Name for logging
        
        Returns:
            Dictionary mapping n-grams to lists of entries
        """
        self.log(f"Building hash index for {sheet_name}...")
        
        ngram_size = 10
        hash_index = defaultdict(list)
        
        for idx, (entry, metadata) in enumerate(entries, 1):
            normalized = self.normalize_string(entry)
            
            # Extract all n-grams
            if len(normalized) >= ngram_size:
                for i in range(len(normalized) - ngram_size + 1):
                    ngram = normalized[i:i + ngram_size]
                    hash_index[ngram].append((entry, normalized, metadata))
            else:
                # For short entries, use the whole string as key
                hash_index[normalized].append((entry, normalized, metadata))
            
            if idx % 50000 == 0:
                self.log(f"  Indexed {idx:,} entries... ({len(hash_index):,} n-grams)")
        
        self.log(f"✓ Index complete: {len(entries):,} entries, {len(hash_index):,} n-grams\n")
        
        return hash_index
    
    def search_with_hash_index(self, entry, normalized_entry, hash_index, ngram_size=10):
        """
        Search for entry in hash index using substring matching.
        
        Returns:
            List of matches (original_entry, metadata)
        """
        if len(normalized_entry) < ngram_size:
            # For short entries, look up directly
            candidates = hash_index.get(normalized_entry, [])
        else:
            # Extract first n-gram and get candidates
            first_ngram = normalized_entry[:ngram_size]
            candidates = hash_index.get(first_ngram, [])
        
        # Check candidates for substring match
        matches = []
        for orig_entry, norm_entry, metadata in candidates:
            if normalized_entry in norm_entry or norm_entry in normalized_entry:
                matches.append((orig_entry, metadata))
        
        return matches
    
    def compare_data(self):
        try:
            self.log("="*70)
            self.log("STARTING FAST DATA COMPARISON")
            self.log("="*70)
            
            # Load Excel file
            self.log(f"\nLoading: {os.path.basename(self.standardized_file)}")
            wb = load_workbook(self.standardized_file)
            
            if "YOUR DATA" not in wb.sheetnames:
                raise ValueError("'YOUR DATA' sheet not found!")
            if "COWORKER DATA" not in wb.sheetnames:
                raise ValueError("'COWORKER DATA' sheet not found!")
            
            # Step 1: Load YOUR data
            self.log("\n" + "="*70)
            self.log("STEP 1: Loading YOUR DATA")
            self.log("="*70)
            
            your_data = []
            your_sheet = wb["YOUR DATA"]
            
            for row_idx, row in enumerate(your_sheet.iter_rows(min_row=2), 2):
                entry = row[0].value
                origin_file = row[1].value
                
                if entry:
                    your_data.append((str(entry), {'origin_file': origin_file}))
                
                if row_idx % 50000 == 2:
                    self.log(f"  Loaded {row_idx - 1:,} rows...")
            
            self.log(f"✓ Loaded {len(your_data):,} entries from YOUR DATA")
            
            # Step 2: Load COWORKER data
            self.log("\n" + "="*70)
            self.log("STEP 2: Loading COWORKER DATA")
            self.log("="*70)
            
            coworker_data = []
            coworker_sheet = wb["COWORKER DATA"]
            
            for row_idx, row in enumerate(coworker_sheet.iter_rows(min_row=2), 2):
                entry = row[0].value
                source = row[1].value
                
                if entry:
                    coworker_data.append((str(entry), {'source': source}))
                
                if row_idx % 50000 == 2:
                    self.log(f"  Loaded {row_idx - 1:,} rows...")
            
            self.log(f"✓ Loaded {len(coworker_data):,} entries from COWORKER DATA")
            
            # Step 3: Build hash index for COWORKER data (larger dataset gets indexed)
            self.log("\n" + "="*70)
            self.log("STEP 3: Building hash index for COWORKER DATA")
            self.log("="*70)
            
            coworker_index = self.build_hash_index(coworker_data, "COWORKER DATA")
            
            # Step 4: Compare YOUR data against COWORKER index
            self.log("="*70)
            self.log("STEP 4: Comparing YOUR DATA with COWORKER DATA")
            self.log("="*70)
            
            in_both = []
            only_in_yours = []
            
            for idx, (your_entry, your_meta) in enumerate(your_data, 1):
                normalized = self.normalize_string(your_entry)
                matches = self.search_with_hash_index(your_entry, normalized, coworker_index)
                
                if matches:
                    # Found in both
                    for coworker_entry, coworker_meta in matches:
                        in_both.append({
                            'your_entry': your_entry,
                            'your_origin': your_meta['origin_file'],
                            'coworker_entry': coworker_entry,
                            'coworker_source': coworker_meta['source']
                        })
                else:
                    # Only in yours
                    only_in_yours.append({
                        'entry': your_entry,
                        'origin_file': your_meta['origin_file']
                    })
                
                if idx % 50000 == 0:
                    self.log(f"  Processed {idx:,}/{len(your_data):,} entries...")
            
            self.log(f"✓ Comparison complete")
            
            # Step 5: Find entries only in COWORKER data
            self.log("\n" + "="*70)
            self.log("STEP 5: Finding entries ONLY in COWORKER DATA")
            self.log("="*70)
            
            # Build index for YOUR data
            your_index = self.build_hash_index(your_data, "YOUR DATA")
            
            only_in_coworker = []
            
            for idx, (coworker_entry, coworker_meta) in enumerate(coworker_data, 1):
                normalized = self.normalize_string(coworker_entry)
                matches = self.search_with_hash_index(coworker_entry, normalized, your_index)
                
                if not matches:
                    # Only in coworker's
                    only_in_coworker.append({
                        'entry': coworker_entry,
                        'source': coworker_meta['source']
                    })
                
                if idx % 50000 == 0:
                    self.log(f"  Processed {idx:,}/{len(coworker_data):,} entries...")
            
            self.log(f"✓ Found entries only in COWORKER DATA")
            
            # Step 6: Create comparison report
            self.log("\n" + "="*70)
            self.log("STEP 6: Creating comparison report")
            self.log("="*70)
            
            output_file = self.create_comparison_report(
                in_both,
                only_in_yours,
                only_in_coworker,
                len(your_data),
                len(coworker_data)
            )
            
            # Summary
            self.log(f"\n{'='*70}")
            self.log("SUMMARY")
            self.log(f"{'='*70}")
            self.log(f"\nYOUR DATA: {len(your_data):,} entries")
            self.log(f"COWORKER DATA: {len(coworker_data):,} entries")
            self.log(f"\nComparison Results:")
            self.log(f"  ✓ In BOTH: {len(in_both):,} matches")
            self.log(f"  → Only in YOURS: {len(only_in_yours):,} entries")
            self.log(f"  ← Only in COWORKER's: {len(only_in_coworker):,} entries")
            
            match_rate_yours = (len(in_both) / len(your_data) * 100) if your_data else 0
            match_rate_coworker = (len(in_both) / len(coworker_data) * 100) if coworker_data else 0
            
            self.log(f"\nMatch Rates:")
            self.log(f"  Your data matched: {match_rate_yours:.1f}%")
            self.log(f"  Coworker data matched: {match_rate_coworker:.1f}%")
            
            self.log(f"\n{'='*70}")
            self.log("COMPARISON COMPLETE!")
            self.log(f"{'='*70}")
            self.log(f"\nReport saved to: {os.path.basename(output_file)}")
            
            messagebox.showinfo("Success", 
                f"Comparison complete!\n\n"
                f"In both: {len(in_both):,}\n"
                f"Only in yours: {len(only_in_yours):,}\n"
                f"Only in coworker's: {len(only_in_coworker):,}\n\n"
                f"Report saved to:\n{output_file}")
            
        except Exception as e:
            self.log(f"\nERROR: {str(e)}")
            import traceback
            self.log(traceback.format_exc())
            messagebox.showerror("Error", f"An error occurred:\n{str(e)}")
        
        finally:
            self.progress.stop()
            self.compare_button.config(state=tk.NORMAL)
    
    def create_comparison_report(self, in_both, only_yours, only_coworker, your_total, coworker_total):
        """Create detailed comparison report in Excel"""
        
        wb = Workbook()
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])
        
        # Header styling
        header_fill_blue = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        header_fill_green = PatternFill(start_color="00B050", end_color="00B050", fill_type="solid")
        header_fill_orange = PatternFill(start_color="FFA500", end_color="FFA500", fill_type="solid")
        header_fill_red = PatternFill(start_color="FF0000", end_color="FF0000", fill_type="solid")
        header_font = Font(bold=True, color="FFFFFF")
        
        # ==================== SHEET 1: SUMMARY ====================
        summary_sheet = wb.create_sheet("SUMMARY", 0)
        
        summary_sheet['A1'] = "DATA COMPARISON SUMMARY"
        summary_sheet['A1'].font = Font(bold=True, size=16)
        summary_sheet.merge_cells('A1:D1')
        
        row = 3
        summary_sheet[f'A{row}'] = "Total Entries:"
        summary_sheet[f'A{row}'].font = Font(bold=True, size=12)
        row += 1
        summary_sheet[f'A{row}'] = "Your data:"
        summary_sheet[f'B{row}'] = your_total
        summary_sheet[f'B{row}'].number_format = '#,##0'
        row += 1
        summary_sheet[f'A{row}'] = "Coworker data:"
        summary_sheet[f'B{row}'] = coworker_total
        summary_sheet[f'B{row}'].number_format = '#,##0'
        row += 3
        
        summary_sheet[f'A{row}'] = "Comparison Results:"
        summary_sheet[f'A{row}'].font = Font(bold=True, size=12)
        row += 1
        
        summary_sheet[f'A{row}'] = "In BOTH:"
        summary_sheet[f'B{row}'] = len(in_both)
        summary_sheet[f'B{row}'].fill = PatternFill(start_color="C6EFCE", end_color="C6EFCE", fill_type="solid")
        summary_sheet[f'B{row}'].number_format = '#,##0'
        row += 1
        
        summary_sheet[f'A{row}'] = "Only in YOURS:"
        summary_sheet[f'B{row}'] = len(only_yours)
        summary_sheet[f'B{row}'].fill = PatternFill(start_color="FFEB9C", end_color="FFEB9C", fill_type="solid")
        summary_sheet[f'B{row}'].number_format = '#,##0'
        row += 1
        
        summary_sheet[f'A{row}'] = "Only in COWORKER's:"
        summary_sheet[f'B{row}'] = len(only_coworker)
        summary_sheet[f'B{row}'].fill = PatternFill(start_color="FFC7CE", end_color="FFC7CE", fill_type="solid")
        summary_sheet[f'B{row}'].number_format = '#,##0'
        
        summary_sheet.column_dimensions['A'].width = 25
        summary_sheet.column_dimensions['B'].width = 15
        
        self.log("  Created SUMMARY sheet")
        
        # ==================== SHEET 2: IN BOTH ====================
        both_sheet = wb.create_sheet("IN BOTH", 1)
        
        headers = ["Your Entry", "Your Origin File", "Coworker Entry", "Coworker Source"]
        for col, header in enumerate(headers, 1):
            cell = both_sheet.cell(row=1, column=col, value=header)
            cell.fill = header_fill_green
            cell.font = header_font
            cell.alignment = Alignment(horizontal="center")
        
        for row_idx, item in enumerate(in_both, 2):
            both_sheet.cell(row=row_idx, column=1, value=item['your_entry'])
            both_sheet.cell(row=row_idx, column=2, value=item['your_origin'])
            both_sheet.cell(row=row_idx, column=3, value=item['coworker_entry'])
            both_sheet.cell(row=row_idx, column=4, value=item['coworker_source'])
        
        both_sheet.column_dimensions['A'].width = 60
        both_sheet.column_dimensions['B'].width = 30
        both_sheet.column_dimensions['C'].width = 60
        both_sheet.column_dimensions['D'].width = 15
        
        self.log(f"  Created IN BOTH sheet ({len(in_both):,} entries)")
        
        # ==================== SHEET 3: ONLY IN YOURS ====================
        yours_sheet = wb.create_sheet("ONLY IN YOURS", 2)
        
        headers = ["Entry", "Origin File"]
        for col, header in enumerate(headers, 1):
            cell = yours_sheet.cell(row=1, column=col, value=header)
            cell.fill = header_fill_orange
            cell.font = header_font
            cell.alignment = Alignment(horizontal="center")
        
        for row_idx, item in enumerate(only_yours, 2):
            yours_sheet.cell(row=row_idx, column=1, value=item['entry'])
            yours_sheet.cell(row=row_idx, column=2, value=item['origin_file'])
        
        yours_sheet.column_dimensions['A'].width = 60
        yours_sheet.column_dimensions['B'].width = 30
        
        self.log(f"  Created ONLY IN YOURS sheet ({len(only_yours):,} entries)")
        
        # ==================== SHEET 4: ONLY IN COWORKER ====================
        coworker_sheet = wb.create_sheet("ONLY IN COWORKER", 3)
        
        headers = ["Entry", "Source"]
        for col, header in enumerate(headers, 1):
            cell = coworker_sheet.cell(row=1, column=col, value=header)
            cell.fill = header_fill_red
            cell.font = header_font
            cell.alignment = Alignment(horizontal="center")
        
        for row_idx, item in enumerate(only_coworker, 2):
            coworker_sheet.cell(row=row_idx, column=1, value=item['entry'])
            coworker_sheet.cell(row=row_idx, column=2, value=item['source'])
        
        coworker_sheet.column_dimensions['A'].width = 60
        coworker_sheet.column_dimensions['B'].width = 15
        
        self.log(f"  Created ONLY IN COWORKER sheet ({len(only_coworker):,} entries)")
        
        # Save
        directory = os.path.dirname(self.standardized_file)
        output_file = os.path.join(directory, "Comparison_Report.xlsx")
        wb.save(output_file)
        
        return output_file


def main():
    root = tk.Tk()
    app = FastDataComparisonGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
