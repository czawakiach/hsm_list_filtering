#!/usr/bin/env python3
"""
Duplicate Remover for HSM Comparison Results
Removes duplicate entries from ALL MATCHES and ALL UNIQUE sheets,
keeping only unique Tape Entry values.
"""

import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext, ttk
import threading
import os
from collections import defaultdict

try:
    from openpyxl import load_workbook
    from openpyxl.styles import Font, PatternFill, Alignment
except ImportError:
    print("Installing openpyxl...")
    import subprocess
    subprocess.check_call(['pip', 'install', 'openpyxl', '--break-system-packages'])
    from openpyxl import load_workbook
    from openpyxl.styles import Font, PatternFill, Alignment


class DuplicateRemoverGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Duplicate Remover - HSM Results")
        self.root.geometry("800x600")
        
        self.excel_file = None
        
        self.setup_ui()
    
    def setup_ui(self):
        # Main frame
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # Title
        title_label = ttk.Label(main_frame, text="Duplicate Remover for HSM Results", 
                                font=('Arial', 16, 'bold'))
        title_label.grid(row=0, column=0, columnspan=3, pady=10)
        
        subtitle_label = ttk.Label(main_frame, 
                                   text="Removes duplicate Tape Entries from ALL MATCHES and ALL UNIQUE sheets", 
                                   font=('Arial', 10, 'italic'), foreground='blue')
        subtitle_label.grid(row=1, column=0, columnspan=3, pady=(0, 10))
        
        # File selection
        ttk.Label(main_frame, text="Excel file:").grid(row=2, column=0, sticky=tk.W, pady=5)
        self.file_label = ttk.Label(main_frame, text="No file selected", 
                                    foreground="gray", wraplength=500)
        self.file_label.grid(row=2, column=1, sticky=tk.W, padx=5)
        ttk.Button(main_frame, text="Browse...", command=self.select_file).grid(row=2, column=2, padx=5)
        
        # Info box
        info_frame = ttk.LabelFrame(main_frame, text="What this does", padding="10")
        info_frame.grid(row=3, column=0, columnspan=3, pady=20, sticky=(tk.W, tk.E))
        
        info_text = tk.Text(info_frame, height=8, width=90, wrap=tk.WORD)
        info_text.grid(row=0, column=0)
        info_text.insert(tk.END, "This tool will:\n\n")
        info_text.insert(tk.END, "1. Scan the 'ALL MATCHES' sheet for duplicate Tape Entries (Column D)\n")
        info_text.insert(tk.END, "2. Keep only the FIRST occurrence of each unique entry\n")
        info_text.insert(tk.END, "3. Remove all other duplicates\n\n")
        info_text.insert(tk.END, "4. Scan the 'ALL UNIQUE' sheet for duplicate Tape Entries (Column D)\n")
        info_text.insert(tk.END, "5. Keep only the FIRST occurrence of each unique entry\n")
        info_text.insert(tk.END, "6. Remove all other duplicates\n\n")
        info_text.insert(tk.END, "The cleaned file will be saved with '_CLEANED' appended to the filename.")
        info_text.config(state=tk.DISABLED)
        
        # Process button
        self.process_button = ttk.Button(main_frame, text="Remove Duplicates", 
                                        command=self.start_processing, state=tk.DISABLED)
        self.process_button.grid(row=4, column=0, columnspan=3, pady=20)
        
        # Progress bar
        self.progress = ttk.Progressbar(main_frame, mode='indeterminate', length=500)
        self.progress.grid(row=5, column=0, columnspan=3, pady=5)
        
        # Status text area
        ttk.Label(main_frame, text="Processing Status:").grid(row=6, column=0, columnspan=3, sticky=tk.W, pady=(10,0))
        self.status_text = scrolledtext.ScrolledText(main_frame, height=15, width=90, wrap=tk.WORD)
        self.status_text.grid(row=7, column=0, columnspan=3, pady=5)
        
        # Configure grid weights
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(1, weight=1)
        main_frame.rowconfigure(7, weight=1)
    
    def select_file(self):
        filepath = filedialog.askopenfilename(
            title="Select HSM Comparison Results Excel file",
            filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
        )
        if filepath:
            self.excel_file = filepath
            self.file_label.config(text=os.path.basename(filepath), foreground="black")
            self.process_button.config(state=tk.NORMAL)
    
    def log(self, message):
        self.status_text.insert(tk.END, message + "\n")
        self.status_text.see(tk.END)
        self.status_text.update()
    
    def start_processing(self):
        self.process_button.config(state=tk.DISABLED)
        self.status_text.delete(1.0, tk.END)
        self.progress.start()
        
        # Run processing in separate thread
        thread = threading.Thread(target=self.process_file)
        thread.start()
    
    def process_file(self):
        try:
            self.log("="*70)
            self.log("STARTING DUPLICATE REMOVAL & REPORTING")
            self.log("="*70)
            self.log(f"\nInput file: {os.path.basename(self.excel_file)}\n")
            
            # Load workbook
            self.log("Loading Excel file...")
            wb = load_workbook(self.excel_file)
            
            # Check if required sheets exist
            if "ALL MATCHES" not in wb.sheetnames:
                raise ValueError("'ALL MATCHES' sheet not found in workbook!")
            if "ALL UNIQUE" not in wb.sheetnames:
                raise ValueError("'ALL UNIQUE' sheet not found in workbook!")
            
            self.log("✓ Workbook loaded successfully\n")
            
            # Create report workbook for duplicates
            report_wb = self.create_report_workbook()
            
            # Process ALL MATCHES sheet
            self.log("="*70)
            self.log("Processing 'ALL MATCHES' sheet")
            self.log("="*70)
            
            matches_sheet = wb["ALL MATCHES"]
            matches_original_count, matches_unique_count, matches_duplicates_data = self.remove_duplicates_from_sheet(
                matches_sheet, 
                column_index=4,  # Column D (1-indexed: A=1, B=2, C=3, D=4)
                sheet_name="ALL MATCHES"
            )
            
            # Add matches duplicates to report
            if matches_duplicates_data:
                self.add_duplicates_to_report(report_wb, "DUPLICATES - ALL MATCHES", 
                                             matches_duplicates_data, is_matches=True)
            
            # Process ALL UNIQUE sheet
            self.log("\n" + "="*70)
            self.log("Processing 'ALL UNIQUE' sheet")
            self.log("="*70)
            
            unique_sheet = wb["ALL UNIQUE"]
            unique_original_count, unique_unique_count, unique_duplicates_data = self.remove_duplicates_from_sheet(
                unique_sheet,
                column_index=4,  # Column D
                sheet_name="ALL UNIQUE"
            )
            
            # Add unique duplicates to report
            if unique_duplicates_data:
                self.add_duplicates_to_report(report_wb, "DUPLICATES - ALL UNIQUE", 
                                             unique_duplicates_data, is_matches=False)
            
            # Save cleaned workbook
            output_file = self.get_output_filename(self.excel_file, "_CLEANED")
            self.log(f"\n{'='*70}")
            self.log("Saving cleaned file...")
            wb.save(output_file)
            self.log(f"✓ Saved to: {os.path.basename(output_file)}")
            
            # Save duplicates report
            report_file = self.get_output_filename(self.excel_file, "_DUPLICATES_REPORT")
            self.log(f"\nSaving duplicates report...")
            report_wb.save(report_file)
            self.log(f"✓ Report saved to: {os.path.basename(report_file)}")
            
            # Summary
            matches_duplicates = len(matches_duplicates_data)
            unique_duplicates = len(unique_duplicates_data)
            
            self.log(f"\n{'='*70}")
            self.log("SUMMARY")
            self.log(f"{'='*70}")
            self.log(f"\nALL MATCHES:")
            self.log(f"  Original entries: {matches_original_count}")
            self.log(f"  Unique entries: {matches_unique_count}")
            self.log(f"  Duplicates removed: {matches_duplicates}")
            
            self.log(f"\nALL UNIQUE:")
            self.log(f"  Original entries: {unique_original_count}")
            self.log(f"  Unique entries: {unique_unique_count}")
            self.log(f"  Duplicates removed: {unique_duplicates}")
            
            self.log(f"\nTotal duplicates removed: {matches_duplicates + unique_duplicates}")
            self.log(f"\n{'='*70}")
            self.log("PROCESSING COMPLETE!")
            self.log(f"{'='*70}")
            self.log(f"\nOutput files:")
            self.log(f"  1. Cleaned data: {os.path.basename(output_file)}")
            self.log(f"  2. Duplicates report: {os.path.basename(report_file)}")
            
            messagebox.showinfo("Success", 
                f"Duplicates removed successfully!\n\n"
                f"ALL MATCHES: {matches_duplicates} duplicates removed\n"
                f"ALL UNIQUE: {unique_duplicates} duplicates removed\n\n"
                f"Files created:\n"
                f"1. {os.path.basename(output_file)}\n"
                f"2. {os.path.basename(report_file)}")
            
        except Exception as e:
            self.log(f"\nERROR: {str(e)}")
            import traceback
            self.log(traceback.format_exc())
            messagebox.showerror("Error", f"An error occurred:\n{str(e)}")
        
        finally:
            self.progress.stop()
            self.process_button.config(state=tk.NORMAL)
    
    def remove_duplicates_from_sheet(self, sheet, column_index, sheet_name):
        """
        Remove duplicate entries from a sheet based on values in specified column.
        Keeps first occurrence of each unique value.
        
        Args:
            sheet: openpyxl worksheet
            column_index: 1-based column index (A=1, B=2, C=3, D=4, etc.)
            sheet_name: Name for logging
        
        Returns:
            (original_count, unique_count, duplicates_data)
            duplicates_data is a list of dicts with duplicate row information
        """
        self.log(f"Scanning '{sheet_name}' for duplicates in Column D (Tape Entry)...")
        
        # Read all data
        data_rows = []
        seen_values = {}  # Maps value -> first occurrence row data
        duplicates_data = []  # List of duplicate entries with full row data
        header_row = None
        
        for row_idx, row in enumerate(sheet.iter_rows(), 1):
            # First row is header
            if row_idx == 1:
                header_row = [cell.value for cell in row]
                continue
            
            # Get value from target column (column_index is 1-based, but row is 0-based)
            cell_value = row[column_index - 1].value
            
            if cell_value is None:
                continue
            
            # Convert to string for comparison
            cell_value_str = str(cell_value).strip()
            
            # Get full row data
            row_data = [cell.value for cell in row]
            
            if cell_value_str in seen_values:
                # This is a duplicate - record it
                duplicate_info = {
                    'tape_entry': cell_value_str,
                    'row_data': row_data,
                    'first_occurrence': seen_values[cell_value_str]
                }
                duplicates_data.append(duplicate_info)
            else:
                # First occurrence - keep it
                seen_values[cell_value_str] = row_data
                data_rows.append(row)
        
        original_count = len(data_rows) + len(duplicates_data)
        unique_count = len(data_rows)
        duplicate_count = len(duplicates_data)
        
        self.log(f"  Original entries: {original_count}")
        self.log(f"  Unique entries: {unique_count}")
        self.log(f"  Duplicates found: {duplicate_count}")
        
        if duplicate_count > 0:
            self.log(f"\nRemoving {duplicate_count} duplicate(s) from '{sheet_name}'...")
            
            # Clear all rows except header
            sheet.delete_rows(2, sheet.max_row)
            
            # Write back unique rows
            for row_data in data_rows:
                new_row = []
                for cell in row_data:
                    new_row.append(cell.value)
                sheet.append(new_row)
            
            # Reapply header styling
            header_fill = PatternFill(start_color="00B050" if "MATCHES" in sheet_name else "FF0000", 
                                     end_color="00B050" if "MATCHES" in sheet_name else "FF0000", 
                                     fill_type="solid")
            header_font = Font(bold=True, color="FFFFFF")
            
            for cell in sheet[1]:
                cell.fill = header_fill
                cell.font = header_font
                cell.alignment = Alignment(horizontal="center")
            
            self.log(f"✓ Duplicates removed from '{sheet_name}'")
        else:
            self.log(f"✓ No duplicates found in '{sheet_name}'")
        
        return original_count, unique_count, duplicates_data
    
    def create_report_workbook(self):
        """Create a new workbook for the duplicates report"""
        from openpyxl import Workbook
        wb = Workbook()
        
        # Remove default sheet
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])
        
        # Create summary sheet
        summary_sheet = wb.create_sheet("SUMMARY", 0)
        
        # Title
        summary_sheet.merge_cells('A1:D1')
        title_cell = summary_sheet['A1']
        title_cell.value = "DUPLICATES REPORT"
        title_cell.font = Font(bold=True, size=16, color="FFFFFF")
        title_cell.fill = PatternFill(start_color="FF6600", end_color="FF6600", fill_type="solid")
        title_cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # Info
        summary_sheet['A3'] = "This report shows all duplicate entries that were found and removed."
        summary_sheet['A4'] = "Each duplicate is shown with:"
        summary_sheet['A5'] = "  • The duplicate entry details"
        summary_sheet['A6'] = "  • The first occurrence that was kept"
        
        summary_sheet.column_dimensions['A'].width = 80
        
        return wb
    
    def add_duplicates_to_report(self, report_wb, sheet_name, duplicates_data, is_matches=True):
        """
        Add duplicate entries to the report workbook.
        
        Args:
            report_wb: Report workbook
            sheet_name: Name for the sheet
            duplicates_data: List of duplicate info dicts
            is_matches: True if from ALL MATCHES, False if from ALL UNIQUE
        """
        self.log(f"Adding {len(duplicates_data)} duplicates to report sheet '{sheet_name}'...")
        
        sheet = report_wb.create_sheet(sheet_name)
        
        # Headers
        header_fill = PatternFill(start_color="00B050" if is_matches else "FF0000", 
                                  end_color="00B050" if is_matches else "FF0000", 
                                  fill_type="solid")
        header_font = Font(bold=True, color="FFFFFF")
        
        if is_matches:
            headers = ["Duplicate Entry", "Origin File", "Tape", "Country", "Matched HSM Line", "HSM Line #",
                      "First Occurrence - Origin File", "First Occurrence - Tape", "First Occurrence - Country"]
        else:
            headers = ["Duplicate Entry", "Origin File", "Tape", "Country",
                      "First Occurrence - Origin File", "First Occurrence - Tape", "First Occurrence - Country"]
        
        for col, header in enumerate(headers, 1):
            cell = sheet.cell(row=1, column=col, value=header)
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = Alignment(horizontal="center")
        
        # Data
        row = 2
        for dup in duplicates_data:
            tape_entry = dup['tape_entry']
            dup_row = dup['row_data']
            first_row = dup['first_occurrence']
            
            # Write duplicate entry info
            sheet.cell(row=row, column=1, value=tape_entry)
            
            if is_matches:
                # ALL MATCHES: Origin File, Tape, Country, Tape Entry, Matched HSM Line, HSM Line #
                sheet.cell(row=row, column=2, value=dup_row[0])  # Origin File
                sheet.cell(row=row, column=3, value=dup_row[1])  # Tape
                sheet.cell(row=row, column=4, value=dup_row[2])  # Country
                sheet.cell(row=row, column=5, value=dup_row[4])  # Matched HSM Line
                sheet.cell(row=row, column=6, value=dup_row[5])  # HSM Line #
                
                # First occurrence
                sheet.cell(row=row, column=7, value=first_row[0])  # First Origin File
                sheet.cell(row=row, column=8, value=first_row[1])  # First Tape
                sheet.cell(row=row, column=9, value=first_row[2])  # First Country
            else:
                # ALL UNIQUE: Origin File, Tape, Country, Tape Entry
                sheet.cell(row=row, column=2, value=dup_row[0])  # Origin File
                sheet.cell(row=row, column=3, value=dup_row[1])  # Tape
                sheet.cell(row=row, column=4, value=dup_row[2])  # Country
                
                # First occurrence
                sheet.cell(row=row, column=5, value=first_row[0])  # First Origin File
                sheet.cell(row=row, column=6, value=first_row[1])  # First Tape
                sheet.cell(row=row, column=7, value=first_row[2])  # First Country
            
            row += 1
        
        # Adjust column widths
        sheet.column_dimensions['A'].width = 50
        sheet.column_dimensions['B'].width = 30
        sheet.column_dimensions['C'].width = 12
        sheet.column_dimensions['D'].width = 10
        sheet.column_dimensions['E'].width = 60 if is_matches else 30
        sheet.column_dimensions['F'].width = 12 if is_matches else 12
        if is_matches:
            sheet.column_dimensions['G'].width = 30
            sheet.column_dimensions['H'].width = 12
            sheet.column_dimensions['I'].width = 10
        else:
            sheet.column_dimensions['G'].width = 10
        
        # Update summary sheet with counts
        summary_sheet = report_wb["SUMMARY"]
        if is_matches:
            summary_sheet['A8'] = f"Duplicates in ALL MATCHES: {len(duplicates_data)}"
            summary_sheet['A8'].font = Font(bold=True, size=12)
        else:
            summary_sheet['A9'] = f"Duplicates in ALL UNIQUE: {len(duplicates_data)}"
            summary_sheet['A9'].font = Font(bold=True, size=12)
        
        self.log(f"✓ Added {len(duplicates_data)} duplicates to report")
    
    def get_output_filename(self, input_file, suffix):
        """Generate output filename with specified suffix"""
        directory = os.path.dirname(input_file)
        basename = os.path.basename(input_file)
        name, ext = os.path.splitext(basename)
        
        # Remove existing suffix if present to avoid double-naming
        for old_suffix in ['_CLEANED', '_DUPLICATES_REPORT']:
            if name.endswith(old_suffix):
                name = name[:-len(old_suffix)]
        
        output_name = f"{name}{suffix}{ext}"
        return os.path.join(directory, output_name)


def main():
    root = tk.Tk()
    app = DuplicateRemoverGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
